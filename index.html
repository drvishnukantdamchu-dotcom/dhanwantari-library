<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рдзрдиреНрд╡рдВрддрд░реА рдЖрдпреБрд░реНрд╡реЗрдж рдореЗрдбрд┐рдХрд▓ рдХреЙрд▓реЗрдЬ - рд▓рд╛рдпрдмреНрд░рд░реА</title>
    <link rel="stylesheet" href="style.css">
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- xlsx for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
    <div class="header-content">
        <h1>ЁЯПЫя╕П рдзрдиреНрд╡рдВрддрд░реА рдЖрдпреБрд░реНрд╡реЗрдж рдореЗрдбрд┐рдХрд▓ рдХреЙрд▓реЗрдЬ, рдЙрджрдЧреАрд░</h1>
        <h2>ЁЯУЪ рд▓рд╛рдпрдмреНрд░рд░реА рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди рдкреНрд░рдгрд╛рд▓реА</h2>
        <p class="stats" id="headerStats">рдПрдХреВрдг рдкреБрд╕реНрддрдХреЗ: 0 | рдЙрдкрд▓рдмреНрдз: 0 | рд╡рд┐рддрд░рд┐рдд: 0</p>
    </div>
</header>

<!-- ===== NAVIGATION ===== -->
<nav>
    <button class="nav-btn active" onclick="showSection('dashboard')">ЁЯПа рдбреЕрд╢рдмреЛрд░реНрдб</button>
    <button class="nav-btn" onclick="showSection('addBook')">ЁЯУЦ рдкреБрд╕реНрддрдХ рдиреЛрдВрджрдгреА</button>
    <button class="nav-btn" onclick="showSection('searchBook')">ЁЯФН рдкреБрд╕реНрддрдХ рд╢реЛрдзрд╛</button>
    <button class="nav-btn" onclick="showSection('issueReturn')">ЁЯФД рджреЗрд╡рд╛рдг-рдШреЗрд╡рд╛рдг</button>
    <button class="nav-btn" onclick="showSection('students')">ЁЯОУ рд╡рд┐рджреНрдпрд╛рд░реНрдереА</button>
    <button class="nav-btn" onclick="showSection('qrSection')">ЁЯУ▒ QR рдХреЛрдб</button>
    <button class="nav-btn" onclick="showSection('reports')">ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</button>
    <button class="nav-btn" onclick="showSection('backupSection')">ЁЯТ╛ рдмреЕрдХрдЕрдк</button>
</nav>

<!-- ===== DASHBOARD ===== -->
<section id="dashboard" class="section active">
    <h2>ЁЯУК рдбреЕрд╢рдмреЛрд░реНрдб</h2>
    <div class="dashboard-cards">
        <div class="card blue">
            <h3>ЁЯУЪ рдПрдХреВрдг рдкреБрд╕реНрддрдХреЗ</h3>
            <p id="totalBooks">0</p>
        </div>
        <div class="card green">
            <h3>тЬЕ рдЙрдкрд▓рдмреНрдз</h3>
            <p id="availableBooks">0</p>
        </div>
        <div class="card red">
            <h3>ЁЯУд рд╡рд┐рддрд░рд┐рдд</h3>
            <p id="issuedBooks">0</p>
        </div>
        <div class="card purple">
            <h3>ЁЯОУ рд╡рд┐рджреНрдпрд╛рд░реНрдереА</h3>
            <p id="totalStudents">0</p>
        </div>
        <div class="card orange">
            <h3>тЪая╕П рдореБрджрдд рд╕рдВрдкрд▓реЗрд▓реА</h3>
            <p id="overdueBooks">0</p>
        </div>
        <div class="card teal">
            <h3>ЁЯУЕ рдЖрдЬрдЪреЗ рд╡реНрдпрд╡рд╣рд╛рд░</h3>
            <p id="todayTransactions">0</p>
        </div>
    </div>
    <h3>ЁЯУЛ рдЕрд▓реАрдХрдбреАрд▓ рд╡реНрдпрд╡рд╣рд╛рд░</h3>
    <table id="recentTransactions">
        <thead>
            <tr>
                <th>рддрд╛рд░реАрдЦ/рд╡реЗрд│</th>
                <th>рд╡рд┐рджреНрдпрд╛рд░реНрдереА</th>
                <th>рдкреБрд╕реНрддрдХ</th>
                <th>рдкреНрд░рдХрд╛рд░</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<!-- ===== ADD BOOK ===== -->
<section id="addBook" class="section">
    <h2>ЁЯУЦ рдирд╡реАрди рдкреБрд╕реНрддрдХ рдиреЛрдВрджрдгреА</h2>
    <form id="addBookForm">
        <div class="form-grid">
            <div class="form-group">
                <label>рдкреБрд╕реНрддрдХ рдХреНрд░рдорд╛рдВрдХ (Accession No.) *</label>
                <input type="text" id="bookAccNo" required placeholder="рдЙрджрд╛. ACC-00001">
            </div>
            <div class="form-group">
                <label>рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡ *</label>
                <input type="text" id="bookName" required placeholder="рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡ рд▓рд┐рд╣рд╛">
            </div>
            <div class="form-group">
                <label>рд▓реЗрдЦрдХ *</label>
                <input type="text" id="bookAuthor" required placeholder="рд▓реЗрдЦрдХрд╛рдЪреЗ рдирд╛рд╡">
            </div>
            <div class="form-group">
                <label>рдкреНрд░рдХрд╛рд╢рдХ</label>
                <input type="text" id="bookPublisher" placeholder="рдкреНрд░рдХрд╛рд╢рдХрд╛рдЪреЗ рдирд╛рд╡">
            </div>
            <div class="form-group">
                <label>ISBN</label>
                <input type="text" id="bookISBN" placeholder="ISBN рдХреНрд░рдорд╛рдВрдХ">
            </div>
            <div class="form-group">
                <label>рдкреНрд░рдХрд╛рд╢рди рд╡рд░реНрд╖</label>
                <input type="number" id="bookYear" placeholder="2024">
            </div>
            <div class="form-group">
                <label>рд╡рд┐рд╖рдп / Category *</label>
                <select id="bookCategory">
                    <option value="Ayurveda">рдЖрдпреБрд░реНрд╡реЗрдж</option>
                    <option value="Anatomy">рд╢рд░реАрд░рд░рдЪрдирд╛ (Anatomy)</option>
                    <option value="Physiology">рд╢рд░реАрд░рдХреНрд░рд┐рдпрд╛ (Physiology)</option>
                    <option value="Pharmacology">рдФрд╖рдзрд╢рд╛рд╕реНрддреНрд░ (Pharmacology)</option>
                    <option value="Pathology">рд╡рд┐рдХреГрддрд┐рд╢рд╛рд╕реНрддреНрд░ (Pathology)</option>
                    <option value="Surgery">рд╢рд▓реНрдпрддрдВрддреНрд░ (Surgery)</option>
                    <option value="Medicine">рдХрд╛рдпрдЪрд┐рдХрд┐рддреНрд╕рд╛ (Medicine)</option>
                    <option value="Panchakarma">рдкрдВрдЪрдХрд░реНрдо</option>
                    <option value="Rasashastra">рд░рд╕рд╢рд╛рд╕реНрддреНрд░</option>
                    <option value="Dravyaguna">рджреНрд░рд╡реНрдпрдЧреБрдг</option>
                    <option value="Samhita">рд╕рдВрд╣рд┐рддрд╛</option>
                    <option value="General">рд╕рд╛рдорд╛рдиреНрдп</option>
                    <option value="Other">рдЗрддрд░</option>
                </select>
            </div>
            <div class="form-group">
                <label>рд░реЕрдХ/рд╢реЗрд▓реНрдл рдХреНрд░рдорд╛рдВрдХ</label>
                <input type="text" id="bookRack" placeholder="рдЙрджрд╛. R1-S3">
            </div>
            <div class="form-group">
                <label>рдХрд┐рдВрдордд (тВ╣)</label>
                <input type="number" id="bookPrice" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>рдкреНрд░рддреАрдВрдЪреА рд╕рдВрдЦреНрдпрд╛</label>
                <input type="number" id="bookCopies" value="1" min="1">
            </div>
        </div>
        <button type="submit" class="btn-primary">тЬЕ рдкреБрд╕реНрддрдХ рдиреЛрдВрджрдгреА рдХрд░рд╛</button>
    </form>
    <br>
    <h3>ЁЯУе Excel/CSV рдордзреВрди рдкреБрд╕реНрддрдХреЗ Import рдХрд░рд╛</h3>
    <p>15,000 рдкреБрд╕реНрддрдХреЗ рдПрдХрджрдо Import рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА Excel рдлрд╛рдИрд▓ рд╡рд╛рдкрд░рд╛</p>
    <input type="file" id="importBooksFile" accept=".xlsx,.xls,.csv">
    <button onclick="importBooksFromFile()" class="btn-secondary">ЁЯУе Import рдХрд░рд╛</button>
    <a href="#" onclick="downloadTemplate()" class="btn-secondary">ЁЯУД Template рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рд╛</a>
</section>

<!-- ===== SEARCH BOOK ===== -->
<section id="searchBook" class="section">
    <h2>ЁЯФН рдкреБрд╕реНрддрдХ рд╢реЛрдзрд╛</h2>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡, рд▓реЗрдЦрдХ, ISBN, рдХрд┐рдВрд╡рд╛ Accession No. рдиреЗ рд╢реЛрдзрд╛..."
               oninput="searchBooks()">
        <select id="searchCategory" onchange="searchBooks()">
            <option value="">рд╕рд░реНрд╡ рд╡рд┐рд╖рдп</option>
            <option value="Ayurveda">рдЖрдпреБрд░реНрд╡реЗрдж</option>
            <option value="Anatomy">рд╢рд░реАрд░рд░рдЪрдирд╛</option>
            <option value="Physiology">рд╢рд░реАрд░рдХреНрд░рд┐рдпрд╛</option>
            <option value="Pharmacology">рдФрд╖рдзрд╢рд╛рд╕реНрддреНрд░</option>
            <option value="Pathology">рд╡рд┐рдХреГрддрд┐рд╢рд╛рд╕реНрддреНрд░</option>
            <option value="Surgery">рд╢рд▓реНрдпрддрдВрддреНрд░</option>
            <option value="Medicine">рдХрд╛рдпрдЪрд┐рдХрд┐рддреНрд╕рд╛</option>
            <option value="Panchakarma">рдкрдВрдЪрдХрд░реНрдо</option>
            <option value="Rasashastra">рд░рд╕рд╢рд╛рд╕реНрддреНрд░</option>
            <option value="Dravyaguna">рджреНрд░рд╡реНрдпрдЧреБрдг</option>
            <option value="Samhita">рд╕рдВрд╣рд┐рддрд╛</option>
        </select>
        <select id="searchStatus" onchange="searchBooks()">
            <option value="">рд╕рд░реНрд╡ рд╕реНрдерд┐рддреА</option>
            <option value="available">рдЙрдкрд▓рдмреНрдз</option>
            <option value="issued">рд╡рд┐рддрд░рд┐рдд</option>
        </select>
    </div>
    <div id="searchResults"></div>
</section>

<!-- ===== ISSUE/RETURN ===== -->
<section id="issueReturn" class="section">
    <h2>ЁЯФД рдкреБрд╕реНрддрдХ рджреЗрд╡рд╛рдг-рдШреЗрд╡рд╛рдг</h2>
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('issueTab', this)">ЁЯУд рдкреБрд╕реНрддрдХ рджреНрдпрд╛ (Issue)</button>
        <button class="tab-btn" onclick="showTab('returnTab', this)">ЁЯУе рдкреБрд╕реНрддрдХ рдкрд░рдд (Return)</button>
    </div>

    <div id="issueTab" class="tab-content active">
        <form id="issueForm">
            <div class="form-grid">
                <div class="form-group">
                    <label>рдкреБрд╕реНрддрдХ Accession No. / QR рд╕реНрдХреЕрди *</label>
                    <input type="text" id="issueBookId" required placeholder="Accession No. рдЯрд╛рдХрд╛ рдХрд┐рдВрд╡рд╛ QR рд╕реНрдХреЕрди рдХрд░рд╛">
                    <button type="button" onclick="startQRScan('issueBookId')" class="btn-small">ЁЯУ╖ QR рд╕реНрдХреЕрди</button>
                </div>
                <div class="form-group">
                    <label>рд╡рд┐рджреНрдпрд╛рд░реНрдереА ID / рд░реЛрд▓ рдирдВрдмрд░ *</label>
                    <input type="text" id="issueStudentId" required placeholder="рд╡рд┐рджреНрдпрд╛рд░реНрдереА ID рдЯрд╛рдХрд╛">
                </div>
                <div class="form-group">
                    <label>рдкрд░рдд рдХрд░рдгреНрдпрд╛рдЪреА рддрд╛рд░реАрдЦ *</label>
                    <input type="date" id="issueDueDate" required>
                </div>
            </div>
            <div id="issueBookInfo" class="info-box"></div>
            <div id="issueStudentInfo" class="info-box"></div>
            <button type="submit" class="btn-primary">ЁЯУд рдкреБрд╕реНрддрдХ Issue рдХрд░рд╛</button>
        </form>
    </div>

    <div id="returnTab" class="tab-content">
        <form id="returnForm">
            <div class="form-group">
                <label>рдкреБрд╕реНрддрдХ Accession No. / QR рд╕реНрдХреЕрди *</label>
                <input type="text" id="returnBookId" required placeholder="Accession No. рдЯрд╛рдХрд╛ рдХрд┐рдВрд╡рд╛ QR рд╕реНрдХреЕрди рдХрд░рд╛">
                <button type="button" onclick="startQRScan('returnBookId')" class="btn-small">ЁЯУ╖ QR рд╕реНрдХреЕрди</button>
            </div>
            <div id="returnBookInfo" class="info-box"></div>
            <button type="submit" class="btn-primary">ЁЯУе рдкреБрд╕реНрддрдХ рдкрд░рдд рдХрд░рд╛</button>
        </form>
    </div>
</section>

<!-- ===== STUDENTS ===== -->
<section id="students" class="section">
    <h2>ЁЯОУ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдиреЛрдВрджрдгреА</h2>
    <form id="addStudentForm">
        <div class="form-grid">
            <div class="form-group">
                <label>рд░реЛрд▓ рдирдВрдмрд░ / ID *</label>
                <input type="text" id="studentId" required>
            </div>
            <div class="form-group">
                <label>рд╡рд┐рджреНрдпрд╛рд░реНрдереНрдпрд╛рдЪреЗ рдирд╛рд╡ *</label>
                <input type="text" id="studentName" required>
            </div>
            <div class="form-group">
                <label>рд╡рд░реНрдЧ / Year *</label>
                <select id="studentYear">
                    <option value="1st BAMS">1st BAMS</option>
                    <option value="2nd BAMS">2nd BAMS</option>
                    <option value="3rd BAMS">3rd BAMS</option>
                    <option value="4th BAMS">Final BAMS</option>
                    <option value="MD">MD (PG)</option>
                    <option value="MS">MS (PG)</option>
                    <option value="Faculty">Faculty</option>
                </select>
            </div>
            <div class="form-group">
                <label>рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░</label>
                <input type="tel" id="studentPhone">
            </div>
            <div class="form-group">
                <label>рдИрдореЗрд▓</label>
                <input type="email" id="studentEmail">
            </div>
        </div>
        <button type="submit" class="btn-primary">тЬЕ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдиреЛрдВрджрдгреА</button>
    </form>
    <br>
    <input type="text" id="studentSearch" placeholder="рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд╢реЛрдзрд╛..." oninput="searchStudents()">
    <div id="studentList"></div>
</section>

<!-- ===== QR CODE ===== -->
<section id="qrSection" class="section">
    <h2>ЁЯУ▒ QR рдХреЛрдб рдЬрдирд░реЗрдЯ рдХрд░рд╛</h2>
    <div class="form-grid">
        <div class="form-group">
            <label>рдкреБрд╕реНрддрдХ Accession No.</label>
            <input type="text" id="qrBookId" placeholder="ACC-00001">
            <button onclick="generateSingleQR()" class="btn-primary">ЁЯУ▒ QR рддрдпрд╛рд░ рдХрд░рд╛</button>
        </div>
        <div class="form-group">
            <label>рдмреЕрдЪ QR (рд╕рд░реНрд╡ рдкреБрд╕реНрддрдХрд╛рдВрд╕рд╛рдареА)</label>
            <button onclick="generateBatchQR()" class="btn-secondary">ЁЯУ▒ рд╕рд░реНрд╡ QR рддрдпрд╛рд░ рдХрд░рд╛</button>
            <button onclick="printQRBatch()" class="btn-secondary">ЁЯЦия╕П рдерд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯ (Batch)</button>
        </div>
    </div>
    <div id="qrOutput" class="qr-grid"></div>
    <!-- QR Size for Thermal Printer -->
    <div class="form-group">
        <label>QR рдЖрдХрд╛рд░ (рдерд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯрд░ рд╕рд╛рдареА)</label>
        <select id="qrSize">
            <option value="100">Small (100x100) - 58mm рдкреНрд░рд┐рдВрдЯрд░</option>
            <option value="150" selected>Medium (150x150) - 80mm рдкреНрд░рд┐рдВрдЯрд░</option>
            <option value="200">Large (200x200)</option>
        </select>
    </div>
</section>

<!-- ===== REPORTS ===== -->
<section id="reports" class="section">
    <h2>ЁЯУК рд░рд┐рдкреЛрд░реНрдЯ</h2>
    <div class="form-grid">
        <button onclick="generateReport('daily')" class="btn-secondary">ЁЯУЕ рдЖрдЬрдЪрд╛ рд░рд┐рдкреЛрд░реНрдЯ</button>
        <button onclick="generateReport('overdue')" class="btn-secondary">тЪая╕П рдореБрджрдд рд╕рдВрдкрд▓реЗрд▓реА рдкреБрд╕реНрддрдХреЗ</button>
        <button onclick="generateReport('popular')" class="btn-secondary">тнР рд▓реЛрдХрдкреНрд░рд┐рдп рдкреБрд╕реНрддрдХреЗ</button>
        <button onclick="generateReport('student')" class="btn-secondary">ЁЯОУ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд░рд┐рдкреЛрд░реНрдЯ</button>
        <button onclick="exportToExcel()" class="btn-secondary">ЁЯУе Excel Export</button>
    </div>
    <div id="reportOutput"></div>
</section>

<!-- ===== BACKUP ===== -->
<section id="backupSection" class="section">
    <h2>ЁЯТ╛ рдмреЕрдХрдЕрдк рдЖрдгрд┐ рд░рд┐рд╕реНрдЯреЛрд░</h2>
    <div class="backup-cards">
        <div class="card blue">
            <h3>ЁЯУе рдмреЕрдХрдЕрдк рддрдпрд╛рд░ рдХрд░рд╛</h3>
            <p>рд╕рдВрдкреВрд░реНрдг рдбреЗрдЯрд╛рдЪреА JSON рдлрд╛рдИрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рд╛</p>
            <button onclick="createBackup()" class="btn-primary">ЁЯТ╛ рдмреЕрдХрдЕрдк рдбрд╛рдЙрдирд▓реЛрдб</button>
        </div>
        <div class="card green">
            <h3>ЁЯУд рдбреЗрдЯрд╛ рд░рд┐рд╕реНрдЯреЛрд░ рдХрд░рд╛</h3>
            <p>JSON рдмреЕрдХрдЕрдк рдлрд╛рдИрд▓ рдЕрдкрд▓реЛрдб рдХрд░реВрди рдбреЗрдЯрд╛ рдкрд░рдд рдЖрдгрд╛</p>
            <input type="file" id="restoreFile" accept=".json">
            <button onclick="restoreBackup()" class="btn-primary">ЁЯУд рд░рд┐рд╕реНрдЯреЛрд░ рдХрд░рд╛</button>
        </div>
        <div class="card orange">
            <h3>тШБя╕П Auto Backup</h3>
            <p>рджрд░рд░реЛрдЬ рд╕реНрд╡рдпрдВрдЪрд▓рд┐рдд рдмреЕрдХрдЕрдк</p>
            <label><input type="checkbox" id="autoBackup" onchange="toggleAutoBackup()"> Auto Backup рдЪрд╛рд▓реВ рдХрд░рд╛</label>
            <p id="lastBackupTime">рд╢реЗрд╡рдЯрдЪрд╛ рдмреЕрдХрдЕрдк: рдХрдзреАрдЪ рдирд╛рд╣реА</p>
        </div>
    </div>
</section>

<!-- ===== QR SCANNER MODAL ===== -->
<div id="qrScannerModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>ЁЯУ╖ QR рдХреЛрдб рд╕реНрдХреЕрди рдХрд░рд╛</h3>
        <video id="qrVideo" width="300" height="300"></video>
        <button onclick="closeQRScanner()" class="btn-secondary">тЭМ рдмрдВрдж рдХрд░рд╛</button>
    </div>
</div>

<!-- ===== NOTIFICATION ===== -->
<div id="notification" class="notification"></div>

<!-- ===== SCRIPTS ===== -->
<script src="db.js"></script>
<script src="qr.js"></script>
<script src="backup.js"></script>
<script src="print.js"></script>
<script src="app.js"></script>

</body>
</html>
/* ===== GLOBAL STYLES ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    color: #333;
}

/* ===== HEADER ===== */
header {
    background: linear-gradient(135deg, #1a5276, #2e86c1);
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

header h1 {
    font-size: 1.5em;
    margin-bottom: 5px;
}

header h2 {
    font-size: 1.1em;
    font-weight: normal;
    opacity: 0.9;
}

header .stats {
    margin-top: 10px;
    font-size: 0.9em;
    opacity: 0.8;
}

/* ===== NAVIGATION ===== */
nav {
    background: #2c3e50;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.nav-btn {
    background: transparent;
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.3s;
}

.nav-btn:hover, .nav-btn.active {
    background: #3498db;
    border-color: #3498db;
}

/* ===== SECTIONS ===== */
.section {
    display: none;
    max-width: 1200px;
    margin: 20px auto;
    padding: 25px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section.active {
    display: block;
}

.section h2 {
    color: #1a5276;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
}

/* ===== DASHBOARD CARDS ===== */
.dashboard-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.card {
    padding: 20px;
    border-radius: 10px;
    color: white;
    text-align: center;
}

.card h3 {
    font-size: 0.9em;
    margin-bottom: 10px;
}

.card p {
    font-size: 2em;
    font-weight: bold;
}

.card.blue { background: linear-gradient(135deg, #2980b9, #3498db); }
.card.green { background: linear-gradient(135deg, #27ae60, #2ecc71); }
.card.red { background: linear-gradient(135deg, #c0392b, #e74c3c); }
.card.purple { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
.card.orange { background: linear-gradient(135deg, #d35400, #e67e22); }
.card.teal { background: linear-gradient(135deg, #16a085, #1abc9c); }

/* ===== FORMS ===== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-group label {
    font-weight: 600;
    color: #555;
    font-size: 0.9em;
}

.form-group input, .form-group select {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
    transition: border-color 0.3s;
}

.form-group input:focus, .form-group select:focus {
    border-color: #3498db;
    outline: none;
}

/* ===== BUTTONS ===== */
.btn-primary {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.3s;
}

.btn-primary:hover { background: #2980b9; }

.btn-secondary {
    background: #95a5a6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    text-decoration: none;
    display: inline-block;
    margin: 5px;
}

.btn-secondary:hover { background: #7f8c8d; }

.btn-small {
    background: #e67e22;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8em;
    margin-top: 5px;
}

.btn-danger {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
}

/* ===== TABLES ===== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

th, td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
    font-size: 0.9em;
}

th {
    background: #2c3e50;
    color: white;
    position: sticky;
    top: 50px;
}

tr:hover { background: #f5f5f5; }

/* ===== SEARCH BAR ===== */
.search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-bar input {
    flex: 1;
    min-width: 250px;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
}

.search-bar select {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 5px;
}

/* ===== TABS ===== */
.tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 10px 20px;
    border: 2px solid #ddd;
    background: #f5f5f5;
    cursor: pointer;
    border-radius: 5px 5px 0 0;
}

.tab-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ===== INFO BOX ===== */
.info-box {
    background: #eaf2f8;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
    border-left: 4px solid #3498db;
}

/* ===== QR GRID ===== */
.qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.qr-item {
    text-align: center;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.qr-item p {
    margin-top: 8px;
    font-size: 0.85em;
    font-weight: bold;
}

/* ===== NOTIFICATION ===== */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 1000;
    display: none;
    animation: slideIn 0.3s ease;
}

.notification.success { background: #27ae60; display: block; }
.notification.error { background: #e74c3c; display: block; }
.notification.warning { background: #f39c12; display: block; }

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

/* ===== MODAL ===== */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
}

/* ===== BACKUP CARDS ===== */
.backup-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.backup-cards .card {
    text-align: left;
}

.backup-cards .card p {
    font-size: 0.9em;
    font-weight: normal;
    margin-bottom: 15px;
}

.backup-cards input[type="file"] {
    margin: 10px 0;
    color: white;
}

/* ===== STATUS BADGES ===== */
.badge {
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

.badge-available { background: #d4efdf; color: #27ae60; }
.badge-issued { background: #fadbd8; color: #e74c3c; }
.badge-overdue { background: #f9e79f; color: #d35400; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    header h1 { font-size: 1.1em; }
    .section { margin: 10px; padding: 15px; }
    .form-grid { grid-template-columns: 1fr; }
    .dashboard-cards { grid-template-columns: repeat(2, 1fr); }
    nav { padding: 5px; }
    .nav-btn { padding: 6px 10px; font-size: 0.75em; }
}

/* ===== PRINT STYLES ===== */
@media print {
    header, nav, .btn-primary, .btn-secondary, .btn-small { display: none; }
    .section { box-shadow: none; margin: 0; }
    .qr-item { break-inside: avoid; }
}
// ===== Main Application Logic =====
// рдзрдиреНрд╡рдВрддрд░реА рдЖрдпреБрд░реНрд╡реЗрдж рдореЗрдбрд┐рдХрд▓ рдХреЙрд▓реЗрдЬ рд▓рд╛рдпрдмреНрд░рд░реА

// Initialize App
document.addEventListener('DOMContentLoaded', async () => {
    await initDB();
    updateDashboard();
    updateLastBackupDisplay();

    // Check auto backup
    const autoBackup = localStorage.getItem('autoBackupEnabled') === 'true';
    const checkbox = document.getElementById('autoBackup');
    if (checkbox) checkbox.checked = autoBackup;
    if (autoBackup) checkAutoBackup();

    // Set default due date (14 days from now)
    const dueDate = document.getElementById('issueDueDate');
    if (dueDate) {
        const d = new Date();
        d.setDate(d.getDate() + 14);
        dueDate.value = d.toISOString().split('T')[0];
    }

    // Periodic localStorage backup
    setInterval(localStorageBackup, 300000); // Every 5 min
});

// ===== NAVIGATION =====

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    event.target.classList.add('active');

    if (sectionId === 'dashboard') updateDashboard();
}

function showTab(tabId, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}

// ===== NOTIFICATION =====

function showNotification(message, type = 'success') {
    const notif = document.getElementById('notification');
    notif.textContent = message;
    notif.className = `notification ${type}`;
    setTimeout(() => {
        notif.className = 'notification';
    }, 4000);
}

// ===== DASHBOARD =====

async function updateDashboard() {
    const counts = await getDashboardCounts();

    document.getElementById('totalBooks').textContent = counts.totalBooks;
    document.getElementById('availableBooks').textContent = counts.availableBooks;
    document.getElementById('issuedBooks').textContent = counts.issuedBooks;
    document.getElementById('totalStudents').textContent = counts.totalStudents;
    document.getElementById('overdueBooks').textContent = counts.overdueBooks;
    document.getElementById('todayTransactions').textContent = counts.todayTransactions;

    document.getElementById('headerStats').textContent =
        `рдПрдХреВрдг рдкреБрд╕реНрддрдХреЗ: ${counts.totalBooks} | рдЙрдкрд▓рдмреНрдз: ${counts.availableBooks} | рд╡рд┐рддрд░рд┐рдд: ${counts.issuedBooks}`;

    // Recent Transactions
    const tbody = document.querySelector('#recentTransactions tbody');
    tbody.innerHTML = '';
    counts.recentTransactions.forEach(txn => {
        const tr = document.createElement('tr');
        const date = new Date(txn.date);
        tr.innerHTML = `
            <td>${date.toLocaleDateString('mr-IN')} ${date.toLocaleTimeString('mr-IN')}</td>
            <td>${txn.studentName || txn.studentId}</td>
            <td>${txn.bookName || txn.bookAccNo}</td>
            <td><span class="badge ${txn.type === 'issue' ? 'badge-issued' : 'badge-available'}">
                ${txn.type === 'issue' ? 'ЁЯУд рд╡рд┐рддрд░рд┐рдд' : 'ЁЯУе рдкрд░рдд'}
            </span></td>
        `;
        tbody.appendChild(tr);
    });
}

// ===== ADD BOOK =====

document.getElementById('addBookForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const book = {
        accNo: document.getElementById('bookAccNo').value.trim(),
        name: document.getElementById('bookName').value.trim(),
        author: document.getElementById('bookAuthor').value.trim(),
        publisher: document.getElementById('bookPublisher').value.trim(),
        isbn: document.getElementById('bookISBN').value.trim(),
        year: document.getElementById('bookYear').value,
        category: document.getElementById('bookCategory').value,
        rack: document.getElementById('bookRack').value.trim(),
        price: document.getElementById('bookPrice').value,
        copies: parseInt(document.getElementById('bookCopies').value) || 1
    };

    try {
        await addBook(book);
        showNotification(`тЬЕ "${book.name}" рдкреБрд╕реНрддрдХ рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рдиреЛрдВрджрдгреА рдХреЗрд▓реЗ!`, 'success');
        e.target.reset();
        updateDashboard();
    } catch (err) {
        if (err.name === 'ConstraintError') {
            showNotification('тЭМ рд╣рд╛ Accession No. рдЖрдзреАрдЪ рдЖрд╣реЗ!', 'error');
        } else {
            showNotification('тЭМ рдиреЛрдВрджрдгреА рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
        }
    }
});

// ===== SEARCH BOOKS =====

async function searchBooks() {
    const query = document.getElementById('searchInput').value.trim();
    const category = document.getElementById('searchCategory').value;
    const status = document.getElementById('searchStatus').value;

    const results = await searchBooksDB(query, category, status);
    const container = document.getElementById('searchResults');

    if (results.length === 0) {
        container.innerHTML = '<p>рдХреЛрдгрддреЗрд╣реА рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА.</p>';
        return;
    }

    let html = `<p>рд╕рд╛рдкрдбрд▓реЗрд▓реА рдкреБрд╕реНрддрдХреЗ: <strong>${results.length}</strong></p>`;
    html += `<table><thead><tr>
        <th>Acc No.</th><th>рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡</th><th>рд▓реЗрдЦрдХ</th>
        <th>рд╡рд┐рд╖рдп</th><th>рд░реЕрдХ</th><th>рд╕реНрдерд┐рддреА</th><th>рдХреГрддреА</th>
    </tr></thead><tbody>`;

    results.forEach(book => {
        const statusBadge = book.status === 'available'
            ? '<span class="badge badge-available">тЬЕ рдЙрдкрд▓рдмреНрдз</span>'
            : `<span class="badge badge-issued">ЁЯУд ${book.issuedTo || 'рд╡рд┐рддрд░рд┐рдд'}</span>`;

        html += `<tr>
            <td>${book.accNo}</td>
            <td><strong>${book.name}</strong></td>
            <td>${book.author}</td>
            <td>${book.category}</td>
            <td>${book.rack || '-'}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn-small" onclick="generateQRForBook('${book.accNo}')">ЁЯУ▒ QR</button>
                <button class="btn-danger" onclick="confirmDeleteBook('${book.accNo}')" style="font-size:0.7em;padding:3px 8px;">ЁЯЧСя╕П</button>
            </td>
        </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function generateQRForBook(accNo) {
    document.getElementById('qrBookId').value = accNo;
    showSection('qrSection');
    // Manually trigger navigation styling
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    generateSingleQR();
}

function confirmDeleteBook(accNo) {
    if (confirm(`"${accNo}" рдкреБрд╕реНрддрдХ рдХрд╛рдпрдордЪреЗ рд╣рдЯрд╡рд╛рдпрдЪреЗ?`)) {
        deleteBook(accNo).then(() => {
            showNotification('рдкреБрд╕реНрддрдХ рд╣рдЯрд╡рд▓реЗ', 'success');
            searchBooks();
            updateDashboard();
        });
    }
}

// ===== ISSUE BOOK =====

document.getElementById('issueForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const bookAccNo = document.getElementById('issueBookId').value.trim();
    const studentId = document.getElementById('issueStudentId').value.trim();
    const dueDate = document.getElementById('issueDueDate').value;

    try {
        const book = await getBook(bookAccNo);
        if (!book) {
            showNotification('тЭМ рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА', 'error');
            return;
        }
        if (book.status === 'issued') {
            showNotification('тЭМ рд╣реЗ рдкреБрд╕реНрддрдХ рдЖрдзреАрдЪ рд╡рд┐рддрд░рд┐рдд рдЖрд╣реЗ!', 'error');
            return;
        }

        const student = await getStudent(studentId);
        if (!student) {
            showNotification('тЭМ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рдЖрдзреА рдиреЛрдВрджрдгреА рдХрд░рд╛.', 'error');
            return;
        }

        // Update book status
        book.status = 'issued';
        book.issuedTo = studentId;
        book.issuedToName = student.name;
        book.issueDate = new Date().toISOString();
        book.dueDate = dueDate;
        book.issueHistory.push({
            studentId: studentId,
            studentName: student.name,
            issueDate: book.issueDate,
            dueDate: dueDate
        });
        await updateBook(book);

        // Update student
        if (!student.booksIssued) student.booksIssued = [];
        student.booksIssued.push(bookAccNo);
        await updateStudent(student);

        // Add transaction
        await addTransaction({
            type: 'issue',
            bookAccNo: bookAccNo,
            bookName: book.name,
            studentId: studentId,
            studentName: student.name,
            dueDate: dueDate
        });

        showNotification(`тЬЕ "${book.name}" тЖТ ${student.name} рд▓рд╛ рд╡рд┐рддрд░рд┐рдд рдХреЗрд▓реЗ!`, 'success');
        e.target.reset();
        updateDashboard();

        // Reset due date
        const d = new Date();
        d.setDate(d.getDate() + 14);
        document.getElementById('issueDueDate').value = d.toISOString().split('T')[0];

    } catch (err) {
        showNotification('тЭМ Issue рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
    }
});

// ===== RETURN BOOK =====

document.getElementById('returnForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const bookAccNo = document.getElementById('returnBookId').value.trim();

    try {
        const book = await getBook(bookAccNo);
        if (!book) {
            showNotification('тЭМ рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА', 'error');
            return;
        }
        if (book.status !== 'issued') {
            showNotification('тЭМ рд╣реЗ рдкреБрд╕реНрддрдХ рд╡рд┐рддрд░рд┐рдд рдирд╛рд╣реА!', 'error');
            return;
        }

        const studentId = book.issuedTo;
        const studentName = book.issuedToName;

        // Check overdue
        let overdueMsg = '';
        if (book.dueDate && new Date(book.dueDate) < new Date()) {
            const days = Math.floor((new Date() - new Date(book.dueDate)) / (1000*60*60*24));
            overdueMsg = ` (тЪая╕П ${days} рджрд┐рд╡рд╕ рдЙрд╢реАрд░!)`;
        }

        // Update last history entry with return date
        if (book.issueHistory.length > 0) {
            book.issueHistory[book.issueHistory.length - 1].returnDate = new Date().toISOString();
        }

        // Reset book
        book.status = 'available';
        book.issuedTo = null;
        book.issuedToName = null;
        book.issueDate = null;
        book.dueDate = null;
        await updateBook(book);

        // Update student
        if (studentId) {
            const student = await getStudent(studentId);
            if (student) {
                student.booksIssued = (student.booksIssued || []).filter(id => id !== bookAccNo);
                await updateStudent(student);
            }
        }

        // Add transaction
        await addTransaction({
            type: 'return',
            bookAccNo: bookAccNo,
            bookName: book.name,
            studentId: studentId,
            studentName: studentName
        });

        showNotification(`тЬЕ "${book.name}" рдкрд░рдд рдХреЗрд▓реЗ! ${overdueMsg}`, 'success');
        e.target.reset();
        updateDashboard();

    } catch (err) {
        showNotification('тЭМ Return рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
    }
});

// ===== STUDENTS =====

document.getElementById('addStudentForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const student = {
        studentId: document.getElementById('studentId').value.trim(),
        name: document.getElementById('studentName').value.trim(),
        year: document.getElementById('studentYear').value,
        phone: document.getElementById('studentPhone').value.trim(),
        email: document.getElementById('studentEmail').value.trim()
    };

    try {
        await addStudent(student);
        showNotification(`тЬЕ "${student.name}" рд╡рд┐рджреНрдпрд╛рд░реНрдереА рдиреЛрдВрджрдгреА рдпрд╢рд╕реНрд╡реА!`, 'success');
        e.target.reset();
        searchStudents();
        updateDashboard();
    } catch (err) {
        if (err.name === 'ConstraintError') {
            showNotification('тЭМ рд╣рд╛ Student ID рдЖрдзреАрдЪ рдЖрд╣реЗ!', 'error');
        } else {
            showNotification('тЭМ рдиреЛрдВрджрдгреА рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
        }
    }
});

async function searchStudents() {
    const query = document.getElementById('studentSearch')?.value.trim().toLowerCase() || '';
    const students = await getAllStudents();
    const container = document.getElementById('studentList');

    let filtered = students;
    if (query) {
        filtered = students.filter(s =>
            s.name.toLowerCase().includes(query) ||
            s.studentId.toLowerCase().includes(query) ||
            s.year.toLowerCase().includes(query)
        );
    }

    let html = `<table><thead><tr>
        <th>ID</th><th>рдирд╛рд╡</th><th>рд╡рд░реНрдЧ</th><th>рдлреЛрди</th><th>рдкреБрд╕реНрддрдХреЗ</th>
    </tr></thead><tbody>`;

    filtered.forEach(s => {
        html += `<tr>
            <td>${s.studentId}</td>
            <td>${s.name}</td>
            <td>${s.year}</td>
            <td>${s.phone || '-'}</td>
            <td>${(s.booksIssued || []).length}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

// ===== REPORTS =====

async function generateReport(type) {
    const container = document.getElementById('reportOutput');
    container.innerHTML = '<p>рд░рд┐рдкреЛрд░реНрдЯ рддрдпрд╛рд░ рд╣реЛрдд рдЖрд╣реЗ...</p>';

    const books = await getAllBooks();
    const transactions = await getAllTransactions();

    let html = '';

    switch(type) {
        case 'daily': {
            const today = new Date().toISOString().split('T')[0];
            const todayTxns = transactions.filter(t => t.date?.startsWith(today));
            html = `<h3>ЁЯУЕ рдЖрдЬрдЪрд╛ рд░рд┐рдкреЛрд░реНрдЯ (${new Date().toLocaleDateString('mr-IN')})</h3>`;
            html += `<p>рдПрдХреВрдг рд╡реНрдпрд╡рд╣рд╛рд░: ${todayTxns.length}</p>`;
            html += `<table><thead><tr><th>рд╡реЗрд│</th><th>рдкреНрд░рдХрд╛рд░</th><th>рдкреБрд╕реНрддрдХ</th><th>рд╡рд┐рджреНрдпрд╛рд░реНрдереА</th></tr></thead><tbody>`;
            todayTxns.forEach(t => {
                html += `<tr>
                    <td>${new Date(t.date).toLocaleTimeString('mr-IN')}</td>
                    <td>${t.type === 'issue' ? 'ЁЯУд рд╡рд┐рддрд░рд┐рдд' : 'ЁЯУе рдкрд░рдд'}</td>
                    <td>${t.bookName}</td>
                    <td>${t.studentName}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            break;
        }
        case 'overdue': {
            const overdue = books.filter(b =>
                b.status === 'issued' && b.dueDate && new Date(b.dueDate) < new Date()
            );
            html = `<h3>тЪая╕П рдореБрджрдд рд╕рдВрдкрд▓реЗрд▓реА рдкреБрд╕реНрддрдХреЗ (${overdue.length})</h3>`;
            html += `<table><thead><tr><th>Acc No.</th><th>рдкреБрд╕реНрддрдХ</th><th>рд╡рд┐рджреНрдпрд╛рд░реНрдереА</th><th>рдореБрджрдд</th><th>рдЙрд╢реАрд░ (рджрд┐рд╡рд╕)</th></tr></thead><tbody>`;
            overdue.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(b => {
                const days = Math.floor((new Date() - new Date(b.dueDate)) / (1000*60*60*24));
                html += `<tr>
                    <td>${b.accNo}</td>
                    <td>${b.name}</td>
                    <td>${b.issuedToName || b.issuedTo}</td>
                    <td>${new Date(b.dueDate).toLocaleDateString('mr-IN')}</td>
                    <td style="color:red;font-weight:bold;">${days} рджрд┐рд╡рд╕</td>
                </tr>`;
            });
            html += '</tbody></table>';
            break;
        }
        case 'popular': {
            const bookCounts = {};
            transactions.filter(t => t.type === 'issue').forEach(t => {
                bookCounts[t.bookAccNo] = bookCounts[t.bookAccNo] || { name: t.bookName, count: 0 };
                bookCounts[t.bookAccNo].count++;
            });
            const sorted = Object.entries(bookCounts).sort((a,b) => b[1].count - a[1].count).slice(0, 50);
            html = `<h3>тнР рд╕рд░реНрд╡рд╛рдзрд┐рдХ рд▓реЛрдХрдкреНрд░рд┐рдп рдкреБрд╕реНрддрдХреЗ</h3>`;
            html += `<table><thead><tr><th>#</th><th>Acc No.</th><th>рдкреБрд╕реНрддрдХ</th><th>рд╡реЗрд│рд╛ рд╡рд┐рддрд░рд┐рдд</th></tr></thead><tbody>`;
            sorted.forEach(([accNo, data], i) => {
                html += `<tr><td>${i+1}</td><td>${accNo}</td><td>${data.name}</td><td>${data.count}</td></tr>`;
            });
            html += '</tbody></table>';
            break;
        }
        case 'student': {
            const students = await getAllStudents();
            html = `<h3>ЁЯОУ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд░рд┐рдкреЛрд░реНрдЯ</h3>`;
            html += `<table><thead><tr><th>ID</th><th>рдирд╛рд╡</th><th>рд╡рд░реНрдЧ</th><th>рд╕рдзреНрдпрд╛ рдХрдбреЗ рдкреБрд╕реНрддрдХреЗ</th></tr></thead><tbody>`;
            students.filter(s => (s.booksIssued || []).length > 0).forEach(s => {
                html += `<tr><td>${s.studentId}</td><td>${s.name}</td><td>${s.year}</td><td>${s.booksIssued.length}</td></tr>`;
            });
            html += '</tbody></table>';
            break;
        }
    }

    container.innerHTML = html;
}

// ===== EXCEL EXPORT =====

async function exportToExcel() {
    const books = await getAllBooks();
    const wsData = books.map(b => ({
        'Accession No.': b.accNo,
        'рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡': b.name,
        'рд▓реЗрдЦрдХ': b.author,
        'рдкреНрд░рдХрд╛рд╢рдХ': b.publisher || '',
        'ISBN': b.isbn || '',
        'рд╡рд┐рд╖рдп': b.category,
        'рд░реЕрдХ': b.rack || '',
        'рдХрд┐рдВрдордд': b.price || '',
        'рд╕реНрдерд┐рддреА': b.status === 'available' ? 'рдЙрдкрд▓рдмреНрдз' : 'рд╡рд┐рддрд░рд┐рдд',
        'рд╡рд┐рддрд░рд┐рдд - рд╡рд┐рджреНрдпрд╛рд░реНрдереА': b.issuedToName || '',
        'рдореБрджрдд': b.dueDate || ''
    }));

    const ws = XLSX.utils.json_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'рдкреБрд╕реНрддрдХреЗ');
    XLSX.writeFile(wb, `DAMC_Library_Books_${new Date().toISOString().split('T')[0]}.xlsx`);
    showNotification('тЬЕ Excel рдлрд╛рдИрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдЭрд╛рд▓реА!', 'success');
}

// ===== IMPORT BOOKS FROM FILE =====

async function importBooksFromFile() {
    const fileInput = document.getElementById('importBooksFile');
    const file = fileInput.files[0];
    if (!file) {
        showNotification('рдХреГрдкрдпрд╛ рдлрд╛рдИрд▓ рдирд┐рд╡рдбрд╛', 'error');
        return;
    }

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const books = rows.map(row => ({
            accNo: String(row['Accession No.'] || row['accNo'] || row['acc_no'] || '').trim(),
            name: String(row['Book Name'] || row['рдкреБрд╕реНрддрдХрд╛рдЪреЗ рдирд╛рд╡'] || row['name'] || row['title'] || '').trim(),
            author: String(row['Author'] || row['рд▓реЗрдЦрдХ'] || row['author'] || '').trim(),
            publisher: String(row['Publisher'] || row['рдкреНрд░рдХрд╛рд╢рдХ'] || row['publisher'] || '').trim(),
            isbn: String(row['ISBN'] || row['isbn'] || '').trim(),
            year: String(row['Year'] || row['year'] || '').trim(),
            category: String(row['Category'] || row['рд╡рд┐рд╖рдп'] || row['category'] || row['subject'] || 'General').trim(),
            rack: String(row['Rack'] || row['рд░реЕрдХ'] || row['rack'] || '').trim(),
            price: String(row['Price'] || row['рдХрд┐рдВрдордд'] || row['price'] || '').trim(),
            copies: parseInt(row['Copies'] || row['copies'] || 1)
        })).filter(b => b.accNo && b.name);

        if (books.length === 0) {
            showNotification('тЭМ рдлрд╛рдИрд▓рдордзреНрдпреЗ рдпреЛрдЧреНрдп рдбреЗрдЯрд╛ рдирд╛рд╣реА', 'error');
            return;
        }

        const result = await bulkAddBooks(books);
        showNotification(`тЬЕ ${result.added} рдкреБрд╕реНрддрдХреЗ Import рдЭрд╛рд▓реА! (${result.errors} рддреНрд░реБрдЯреА)`, 'success');
        updateDashboard();
    } catch (err) {
        showNotification('тЭМ Import рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
    }
}

// ===== DOWNLOAD TEMPLATE =====

function downloadTemplate() {
    const template = [
        {
            'Accession No.': 'ACC-00001',
            'Book Name': 'Charaka Samhita',
            'Author': 'Agnivesha',
            'Publisher': 'Chaukhamba',
            'ISBN': '978-0000000000',
            'Year': '2020',
            'Category': 'Samhita',
            'Rack': 'R1-S1',
            'Price': '500',
            'Copies': 1
        }
    ];
    const ws = XLSX.utils.json_to_sheet(template);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Template');
    XLSX.writeFile(wb, 'Library_Import_Template.xlsx');
    showNotification('Template рдбрд╛рдЙрдирд▓реЛрдб рдЭрд╛рд▓реА!', 'success');
}

// ===== BOOK INFO PREVIEW =====

document.getElementById('issueBookId')?.addEventListener('blur', async function() {
    const book = await getBook(this.value.trim());
    const info = document.getElementById('issueBookInfo');
    if (book) {
        info.innerHTML = `ЁЯУЪ <strong>${book.name}</strong> | ${book.author} | ${book.category}
            | рд╕реНрдерд┐рддреА: ${book.status === 'available' ? 'тЬЕ рдЙрдкрд▓рдмреНрдз' : 'тЭМ рд╡рд┐рддрд░рд┐рдд'}`;
    } else {
        info.innerHTML = 'тЭМ рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА';
    }
});

document.getElementById('issueStudentId')?.addEventListener('blur', async function() {
    const student = await getStudent(this.value.trim());
    const info = document.getElementById('issueStudentInfo');
    if (student) {
        info.innerHTML = `ЁЯОУ <strong>${student.name}</strong> | ${student.year}
            | рд╕рдзреНрдпрд╛ ${(student.booksIssued || []).length} рдкреБрд╕реНрддрдХреЗ`;
    } else {
        info.innerHTML = 'тЭМ рд╡рд┐рджреНрдпрд╛рд░реНрдереА рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА';
    }
});

document.getElementById('returnBookId')?.addEventListener('blur', async function() {
    const book = await getBook(this.value.trim());
    const info = document.getElementById('returnBookInfo');
    if (book && book.status === 'issued') {
        const overdue = book.dueDate && new Date(book.dueDate) < new Date();
        info.innerHTML = `ЁЯУЪ <strong>${book.name}</strong> | ${book.author}<br>
            ЁЯУд рд╡рд┐рддрд░рд┐рдд: ${book.issuedToName} | рдореБрджрдд: ${new Date(book.dueDate).toLocaleDateString('mr-IN')}
            ${overdue ? '<br><span style="color:red;">тЪая╕П рдореБрджрдд рд╕рдВрдкрд▓реА рдЖрд╣реЗ!</span>' : ''}`;
    } else if (book) {
        info.innerHTML = 'тД╣я╕П рд╣реЗ рдкреБрд╕реНрддрдХ рд╡рд┐рддрд░рд┐рдд рдирд╛рд╣реА, рдкрд░рдд рдХрд░рдгреНрдпрд╛рдЪреА рдЧрд░рдЬ рдирд╛рд╣реА.';
    } else {
        info.innerHTML = 'тЭМ рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА';
    }
});
// ===== IndexedDB Database for Library Management =====
// 15,000+ рдкреБрд╕реНрддрдХрд╛рдВрд╕рд╛рдареА рд╡рд┐рд╢реНрд╡рд╛рд╕рд╛рд░реНрд╣ рдбреЗрдЯрд╛ рд╕реНрдЯреЛрд░реЗрдЬ

const DB_NAME = 'DhanwantariLibraryDB';
const DB_VERSION = 1;
let db;

// Database Initialize
function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // Books Store
            if (!db.objectStoreNames.contains('books')) {
                const bookStore = db.createObjectStore('books', { keyPath: 'accNo' });
                bookStore.createIndex('name', 'name', { unique: false });
                bookStore.createIndex('author', 'author', { unique: false });
                bookStore.createIndex('isbn', 'isbn', { unique: false });
                bookStore.createIndex('category', 'category', { unique: false });
                bookStore.createIndex('status', 'status', { unique: false });
            }

            // Students Store
            if (!db.objectStoreNames.contains('students')) {
                const studentStore = db.createObjectStore('students', { keyPath: 'studentId' });
                studentStore.createIndex('name', 'name', { unique: false });
                studentStore.createIndex('year', 'year', { unique: false });
            }

            // Transactions Store
            if (!db.objectStoreNames.contains('transactions')) {
                const txnStore = db.createObjectStore('transactions', { keyPath: 'txnId', autoIncrement: true });
                txnStore.createIndex('bookAccNo', 'bookAccNo', { unique: false });
                txnStore.createIndex('studentId', 'studentId', { unique: false });
                txnStore.createIndex('type', 'type', { unique: false });
                txnStore.createIndex('date', 'date', { unique: false });
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log('тЬЕ Database initialized successfully');
            resolve(db);
        };

        request.onerror = (event) => {
            console.error('тЭМ Database error:', event.target.error);
            reject(event.target.error);
        };
    });
}

// ===== BOOK OPERATIONS =====

// Add Book
function addBook(book) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readwrite');
        const store = txn.objectStore('books');
        book.status = 'available';
        book.dateAdded = new Date().toISOString();
        book.issuedTo = null;
        book.issueDate = null;
        book.dueDate = null;
        book.issueHistory = [];
        const request = store.add(book);
        request.onsuccess = () => resolve(book);
        request.onerror = () => reject(request.error);
    });
}

// Get Book
function getBook(accNo) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readonly');
        const store = txn.objectStore('books');
        const request = store.get(accNo);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Update Book
function updateBook(book) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readwrite');
        const store = txn.objectStore('books');
        const request = store.put(book);
        request.onsuccess = () => resolve(book);
        request.onerror = () => reject(request.error);
    });
}

// Delete Book
function deleteBook(accNo) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readwrite');
        const store = txn.objectStore('books');
        const request = store.delete(accNo);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

// Get All Books
function getAllBooks() {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readonly');
        const store = txn.objectStore('books');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Search Books
function searchBooksDB(query, category, status) {
    return new Promise((resolve, reject) => {
        getAllBooks().then(books => {
            let results = books;

            if (query) {
                const q = query.toLowerCase();
                results = results.filter(b =>
                    b.name.toLowerCase().includes(q) ||
                    b.author.toLowerCase().includes(q) ||
                    b.accNo.toLowerCase().includes(q) ||
                    (b.isbn && b.isbn.toLowerCase().includes(q)) ||
                    (b.publisher && b.publisher.toLowerCase().includes(q))
                );
            }

            if (category) {
                results = results.filter(b => b.category === category);
            }

            if (status) {
                results = results.filter(b => b.status === status);
            }

            resolve(results);
        }).catch(reject);
    });
}

// ===== STUDENT OPERATIONS =====

function addStudent(student) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('students', 'readwrite');
        const store = txn.objectStore('students');
        student.dateAdded = new Date().toISOString();
        student.booksIssued = [];
        const request = store.add(student);
        request.onsuccess = () => resolve(student);
        request.onerror = () => reject(request.error);
    });
}

function getStudent(studentId) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('students', 'readonly');
        const store = txn.objectStore('students');
        const request = store.get(studentId);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function updateStudent(student) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('students', 'readwrite');
        const store = txn.objectStore('students');
        const request = store.put(student);
        request.onsuccess = () => resolve(student);
        request.onerror = () => reject(request.error);
    });
}

function getAllStudents() {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('students', 'readonly');
        const store = txn.objectStore('students');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ===== TRANSACTION OPERATIONS =====

function addTransaction(txnData) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('transactions', 'readwrite');
        const store = txn.objectStore('transactions');
        txnData.date = new Date().toISOString();
        txnData.timestamp = Date.now();
        const request = store.add(txnData);
        request.onsuccess = () => resolve(txnData);
        request.onerror = () => reject(request.error);
    });
}

function getAllTransactions() {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('transactions', 'readonly');
        const store = txn.objectStore('transactions');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ===== GET COUNTS =====

function getDashboardCounts() {
    return new Promise(async (resolve) => {
        const books = await getAllBooks();
        const students = await getAllStudents();
        const transactions = await getAllTransactions();

        const today = new Date().toISOString().split('T')[0];
        const todayTxns = transactions.filter(t =>
            t.date && t.date.startsWith(today)
        );

        const overdue = books.filter(b =>
            b.status === 'issued' && b.dueDate && new Date(b.dueDate) < new Date()
        );

        resolve({
            totalBooks: books.length,
            availableBooks: books.filter(b => b.status === 'available').length,
            issuedBooks: books.filter(b => b.status === 'issued').length,
            totalStudents: students.length,
            overdueBooks: overdue.length,
            todayTransactions: todayTxns.length,
            recentTransactions: transactions.sort((a, b) => b.timestamp - a.timestamp).slice(0, 20)
        });
    });
}

// ===== BULK IMPORT =====

function bulkAddBooks(booksArray) {
    return new Promise((resolve, reject) => {
        const txn = db.transaction('books', 'readwrite');
        const store = txn.objectStore('books');
        let added = 0;
        let errors = 0;

        booksArray.forEach(book => {
            book.status = book.status || 'available';
            book.dateAdded = new Date().toISOString();
            book.issuedTo = null;
            book.issueDate = null;
            book.dueDate = null;
            book.issueHistory = [];
            const request = store.put(book); // put = add or update
            request.onsuccess = () => added++;
            request.onerror = () => errors++;
        });

        txn.oncomplete = () => resolve({ added, errors });
        txn.onerror = () => reject(txn.error);
    });
}

// ===== EXPORT ALL DATA =====

async function exportAllData() {
    const books = await getAllBooks();
    const students = await getAllStudents();
    const transactions = await getAllTransactions();
    return {
        version: DB_VERSION,
        exportDate: new Date().toISOString(),
        college: 'Dhanwantari Ayurved Medical College, Udgir',
        data: { books, students, transactions }
    };
}

// ===== IMPORT ALL DATA =====

function importAllData(data) {
    return new Promise(async (resolve, reject) => {
        try {
            if (data.data.books) await bulkAddBooks(data.data.books);

            if (data.data.students) {
                const txn = db.transaction('students', 'readwrite');
                const store = txn.objectStore('students');
                data.data.students.forEach(s => store.put(s));
            }

            if (data.data.transactions) {
                const txn = db.transaction('transactions', 'readwrite');
                const store = txn.objectStore('transactions');
                data.data.transactions.forEach(t => store.put(t));
            }

            resolve(true);
        } catch (err) {
            reject(err);
        }
    });
}
// ===== QR Code Generation for Library Books =====
// рдерд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯрд░ рд╕рдкреЛрд░реНрдЯ рд╕рд╣

// Generate Single QR Code
function generateSingleQR() {
    const bookId = document.getElementById('qrBookId').value.trim();
    if (!bookId) {
        showNotification('рдХреГрдкрдпрд╛ Accession No. рдЯрд╛рдХрд╛', 'error');
        return;
    }

    getBook(bookId).then(book => {
        if (!book) {
            showNotification('рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА', 'error');
            return;
        }

        const qrOutput = document.getElementById('qrOutput');
        qrOutput.innerHTML = '';

        const qrItem = createQRElement(book);
        qrOutput.appendChild(qrItem);
    });
}

// Generate Batch QR Codes
async function generateBatchQR() {
    const books = await getAllBooks();
    const qrOutput = document.getElementById('qrOutput');
    qrOutput.innerHTML = '<p>QR рдХреЛрдб рддрдпрд╛рд░ рд╣реЛрдд рдЖрд╣реЗрдд... рдХреГрдкрдпрд╛ рдерд╛рдВрдмрд╛.</p>';

    setTimeout(() => {
        qrOutput.innerHTML = '';
        // Process in batches of 50 for performance
        const batchSize = 50;
        let index = 0;

        function processBatch() {
            const batch = books.slice(index, index + batchSize);
            batch.forEach(book => {
                const qrItem = createQRElement(book);
                qrOutput.appendChild(qrItem);
            });
            index += batchSize;
            if (index < books.length) {
                setTimeout(processBatch, 100);
            } else {
                showNotification(`${books.length} QR рдХреЛрдб рддрдпрд╛рд░ рдЭрд╛рд▓реЗ!`, 'success');
            }
        }
        processBatch();
    }, 100);
}

// Create QR Element
function createQRElement(book) {
    const size = parseInt(document.getElementById('qrSize')?.value || 150);
    const qrItem = document.createElement('div');
    qrItem.className = 'qr-item';
    qrItem.id = 'qr-' + book.accNo;

    const qrDiv = document.createElement('div');
    qrDiv.id = 'qrcode-' + book.accNo;

    // QR Data contains: AccNo | BookName | Author
    const qrData = JSON.stringify({
        id: book.accNo,
        name: book.name,
        author: book.author,
        lib: 'DAMC-Udgir'
    });

    qrItem.appendChild(qrDiv);

    const label = document.createElement('p');
    label.textContent = `${book.accNo} - ${book.name.substring(0, 30)}`;
    qrItem.appendChild(label);

    const authorLabel = document.createElement('small');
    authorLabel.textContent = book.author;
    authorLabel.style.color = '#777';
    qrItem.appendChild(authorLabel);

    // Print button for individual QR
    const printBtn = document.createElement('button');
    printBtn.textContent = 'ЁЯЦия╕П рдкреНрд░рд┐рдВрдЯ';
    printBtn.className = 'btn-small';
    printBtn.onclick = () => printSingleQR(book.accNo);
    qrItem.appendChild(printBtn);

    // Generate QR after DOM append
    setTimeout(() => {
        try {
            new QRCode(qrDiv, {
                text: qrData,
                width: size,
                height: size,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
        } catch(e) {
            console.error('QR generation error for', book.accNo, e);
        }
    }, 50);

    return qrItem;
}

// QR Scanner using Camera
let scannerStream = null;
let scanTargetInput = null;

function startQRScan(targetInputId) {
    scanTargetInput = targetInputId;
    const modal = document.getElementById('qrScannerModal');
    const video = document.getElementById('qrVideo');
    modal.style.display = 'flex';

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
    }).then(stream => {
        scannerStream = stream;
        video.srcObject = stream;
        video.play();
        scanQRFromVideo(video);
    }).catch(err => {
        showNotification('рдХреЕрдореЗрд░рд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА. рдХреГрдкрдпрд╛ Accession No. рдореЕрдиреНрдпреБрдЕрд▓реА рдЯрд╛рдХрд╛.', 'warning');
        closeQRScanner();
    });
}

function scanQRFromVideo(video) {
    // Use canvas to capture frames
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    function scan() {
        if (!scannerStream) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        try {
            // Try using BarcodeDetector API (modern browsers)
            if ('BarcodeDetector' in window) {
                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                detector.detect(canvas).then(barcodes => {
                    if (barcodes.length > 0) {
                        const data = JSON.parse(barcodes[0].rawValue);
                        document.getElementById(scanTargetInput).value = data.id;
                        showNotification(`рд╕реНрдХреЕрди рдпрд╢рд╕реНрд╡реА: ${data.id}`, 'success');
                        closeQRScanner();
                        return;
                    }
                    requestAnimationFrame(scan);
                }).catch(() => requestAnimationFrame(scan));
            } else {
                // Fallback: manual entry
                showNotification('QR Scanner рдпрд╛ рдмреНрд░рд╛рдЙрдЭрд░рдордзреНрдпреЗ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рдореЕрдиреНрдпреБрдЕрд▓реА рдЯрд╛рдХрд╛.', 'warning');
                closeQRScanner();
            }
        } catch(e) {
            requestAnimationFrame(scan);
        }
    }
    scan();
}

function closeQRScanner() {
    if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
    }
    document.getElementById('qrScannerModal').style.display = 'none';
}
// ===== Backup & Restore System =====
// JSON рдмреЕрдХрдЕрдк - рд╡рд┐рд╢реНрд╡рд╛рд╕рд╛рд░реНрд╣ рдЖрдгрд┐ рдХрд╛рдпрдорд╕реНрд╡рд░реВрдкреА

// Create Full Backup
async function createBackup() {
    try {
        const data = await exportAllData();

        const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: 'application/json'
        });

        const date = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('en-IN', {hour12: false}).replace(/:/g, '-');
        const filename = `DAMC_Library_Backup_${date}_${time}.json`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        // Update last backup time
        localStorage.setItem('lastBackupTime', new Date().toISOString());
        updateLastBackupDisplay();

        showNotification(`тЬЕ рдмреЕрдХрдЕрдк рдпрд╢рд╕реНрд╡реА! рдлрд╛рдИрд▓: ${filename}`, 'success');
    } catch (err) {
        showNotification('тЭМ рдмреЕрдХрдЕрдк рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
    }
}

// Restore from Backup
async function restoreBackup() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];

    if (!file) {
        showNotification('рдХреГрдкрдпрд╛ рдмреЕрдХрдЕрдк рдлрд╛рдИрд▓ рдирд┐рд╡рдбрд╛', 'error');
        return;
    }

    if (!confirm('тЪая╕П рд░рд┐рд╕реНрдЯреЛрд░ рдХреЗрд▓реНрдпрд╛рд╡рд░ рд╕рдзреНрдпрд╛рдЪрд╛ рдбреЗрдЯрд╛ рдмрджрд▓рд▓рд╛ рдЬрд╛рдИрд▓. рдкреБрдвреЗ рдЬрд╛рдпрдЪреЗ?')) {
        return;
    }

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        // Validate backup file
        if (!data.data || !data.data.books) {
            throw new Error('рдЕрдорд╛рдиреНрдп рдмреЕрдХрдЕрдк рдлрд╛рдИрд▓');
        }

        await importAllData(data);

        showNotification(`тЬЕ рд░рд┐рд╕реНрдЯреЛрд░ рдпрд╢рд╕реНрд╡реА! ${data.data.books.length} рдкреБрд╕реНрддрдХреЗ, ${data.data.students?.length || 0} рд╡рд┐рджреНрдпрд╛рд░реНрдереА`, 'success');

        // Refresh dashboard
        updateDashboard();
    } catch (err) {
        showNotification('тЭМ рд░рд┐рд╕реНрдЯреЛрд░ рдЕрдпрд╢рд╕реНрд╡реА: ' + err.message, 'error');
    }
}

// Auto Backup
function toggleAutoBackup() {
    const enabled = document.getElementById('autoBackup').checked;
    localStorage.setItem('autoBackupEnabled', enabled);

    if (enabled) {
        showNotification('Auto Backup рдЪрд╛рд▓реВ рдХреЗрд▓рд╛. рджрд░рд░реЛрдЬ рдмреЕрдХрдЕрдк рддрдпрд╛рд░ рд╣реЛрдИрд▓.', 'success');
        checkAutoBackup();
    } else {
        showNotification('Auto Backup рдмрдВрдж рдХреЗрд▓рд╛.', 'warning');
    }
}

function checkAutoBackup() {
    const enabled = localStorage.getItem('autoBackupEnabled') === 'true';
    if (!enabled) return;

    const lastBackup = localStorage.getItem('lastBackupTime');
    const today = new Date().toISOString().split('T')[0];

    if (!lastBackup || !lastBackup.startsWith(today)) {
        // Auto backup today
        createBackup();
    }
}

function updateLastBackupDisplay() {
    const lastBackup = localStorage.getItem('lastBackupTime');
    const el = document.getElementById('lastBackupTime');
    if (el) {
        if (lastBackup) {
            const d = new Date(lastBackup);
            el.textContent = `рд╢реЗрд╡рдЯрдЪрд╛ рдмреЕрдХрдЕрдк: ${d.toLocaleDateString('mr-IN')} ${d.toLocaleTimeString('mr-IN')}`;
        } else {
            el.textContent = 'рд╢реЗрд╡рдЯрдЪрд╛ рдмреЕрдХрдЕрдк: рдХрдзреАрдЪ рдирд╛рд╣реА';
        }
    }
}

// Duplicate backup to localStorage as safety net
async function localStorageBackup() {
    try {
        const data = await exportAllData();
        // Only store summary in localStorage (size limit ~5MB)
        const summary = {
            lastUpdate: new Date().toISOString(),
            bookCount: data.data.books.length,
            studentCount: data.data.students.length,
            txnCount: data.data.transactions.length
        };
        localStorage.setItem('libraryDataSummary', JSON.stringify(summary));
    } catch(e) {
        console.error('localStorage backup error:', e);
    }
}
// ===== QR Code Generation for Library Books =====
// рдерд░реНрдорд▓ рдкреНрд░рд┐рдВрдЯрд░ рд╕рдкреЛрд░реНрдЯ рд╕рд╣

// Generate Single QR Code
function generateSingleQR() {
    const bookId = document.getElementById('qrBookId').value.trim();
    if (!bookId) {
        showNotification('рдХреГрдкрдпрд╛ Accession No. рдЯрд╛рдХрд╛', 'error');
        return;
    }

    getBook(bookId).then(book => {
        if (!book) {
            showNotification('рдкреБрд╕реНрддрдХ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА', 'error');
            return;
        }

        const qrOutput = document.getElementById('qrOutput');
        qrOutput.innerHTML = '';

        const qrItem = createQRElement(book);
        qrOutput.appendChild(qrItem);
    });
}

// Generate Batch QR Codes
async function generateBatchQR() {
    const books = await getAllBooks();
    const qrOutput = document.getElementById('qrOutput');
    qrOutput.innerHTML = '<p>QR рдХреЛрдб рддрдпрд╛рд░ рд╣реЛрдд рдЖрд╣реЗрдд... рдХреГрдкрдпрд╛ рдерд╛рдВрдмрд╛.</p>';

    setTimeout(() => {
        qrOutput.innerHTML = '';
        // Process in batches of 50 for performance
        const batchSize = 50;
        let index = 0;

        function processBatch() {
            const batch = books.slice(index, index + batchSize);
            batch.forEach(book => {
                const qrItem = createQRElement(book);
                qrOutput.appendChild(qrItem);
            });
            index += batchSize;
            if (index < books.length) {
                setTimeout(processBatch, 100);
            } else {
                showNotification(`${books.length} QR рдХреЛрдб рддрдпрд╛рд░ рдЭрд╛рд▓реЗ!`, 'success');
            }
        }
        processBatch();
    }, 100);
}

// Create QR Element
function createQRElement(book) {
    const size = parseInt(document.getElementById('qrSize')?.value || 150);
    const qrItem = document.createElement('div');
    qrItem.className = 'qr-item';
    qrItem.id = 'qr-' + book.accNo;

    const qrDiv = document.createElement('div');
    qrDiv.id = 'qrcode-' + book.accNo;

    // QR Data contains: AccNo | BookName | Author
    const qrData = JSON.stringify({
        id: book.accNo,
        name: book.name,
        author: book.author,
        lib: 'DAMC-Udgir'
    });

    qrItem.appendChild(qrDiv);

    const label = document.createElement('p');
    label.textContent = `${book.accNo} - ${book.name.substring(0, 30)}`;
    qrItem.appendChild(label);

    const authorLabel = document.createElement('small');
    authorLabel.textContent = book.author;
    authorLabel.style.color = '#777';
    qrItem.appendChild(authorLabel);

    // Print button for individual QR
    const printBtn = document.createElement('button');
    printBtn.textContent = 'ЁЯЦия╕П рдкреНрд░рд┐рдВрдЯ';
    printBtn.className = 'btn-small';
    printBtn.onclick = () => printSingleQR(book.accNo);
    qrItem.appendChild(printBtn);

    // Generate QR after DOM append
    setTimeout(() => {
        try {
            new QRCode(qrDiv, {
                text: qrData,
                width: size,
                height: size,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
        } catch(e) {
            console.error('QR generation error for', book.accNo, e);
        }
    }, 50);

    return qrItem;
}

// QR Scanner using Camera
let scannerStream = null;
let scanTargetInput = null;

function startQRScan(targetInputId) {
    scanTargetInput = targetInputId;
    const modal = document.getElementById('qrScannerModal');
    const video = document.getElementById('qrVideo');
    modal.style.display = 'flex';

    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
    }).then(stream => {
        scannerStream = stream;
        video.srcObject = stream;
        video.play();
        scanQRFromVideo(video);
    }).catch(err => {
        showNotification('рдХреЕрдореЗрд░рд╛ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА. рдХреГрдкрдпрд╛ Accession No. рдореЕрдиреНрдпреБрдЕрд▓реА рдЯрд╛рдХрд╛.', 'warning');
        closeQRScanner();
    });
}

function scanQRFromVideo(video) {
    // Use canvas to capture frames
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    function scan() {
        if (!scannerStream) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        try {
            // Try using BarcodeDetector API (modern browsers)
            if ('BarcodeDetector' in window) {
                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                detector.detect(canvas).then(barcodes => {
                    if (barcodes.length > 0) {
                        const data = JSON.parse(barcodes[0].rawValue);
                        document.getElementById(scanTargetInput).value = data.id;
                        showNotification(`рд╕реНрдХреЕрди рдпрд╢рд╕реНрд╡реА: ${data.id}`, 'success');
                        closeQRScanner();
                        return;
                    }
                    requestAnimationFrame(scan);
                }).catch(() => requestAnimationFrame(scan));
            } else {
                // Fallback: manual entry
                showNotification('QR Scanner рдпрд╛ рдмреНрд░рд╛рдЙрдЭрд░рдордзреНрдпреЗ рдЙрдкрд▓рдмреНрдз рдирд╛рд╣реА. рдХреГрдкрдпрд╛ рдореЕрдиреНрдпреБрдЕрд▓реА рдЯрд╛рдХрд╛.', 'warning');
                closeQRScanner();
            }
        } catch(e) {
            requestAnimationFrame(scan);
        }
    }
    scan();
}

function closeQRScanner() {
    if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
    }
    document.getElementById('qrScannerModal').style.display = 'none';
}
